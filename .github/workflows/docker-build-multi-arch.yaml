# .github/workflows/docker-build-multiarch.yml
name: Reusable Multi-Arch Docker Build

on:
  workflow_call:
    inputs:
      image-name:
        description: 'Docker image name (e.g., username/image or ghcr.io/org/image)'
        required: true
        type: string

      context:
        description: 'Build context path'
        required: false
        type: string
        default: '.'

      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'

      platforms:
        description: 'Comma-separated list of platforms (amd64,arm64)'
        required: false
        type: string
        default: 'amd64,arm64'

      registry:
        description: 'Container registry (dockerhub, ghcr, or ecr)'
        required: false
        type: string
        default: 'dockerhub'

      push:
        description: 'Push images to registry'
        required: false
        type: boolean
        default: true

      build-args:
        description: 'Build arguments (multiline string)'
        required: false
        type: string
        default: ''

      tags:
        description: 'Additional custom tags (newline separated)'
        required: false
        type: string
        default: ''

      target:
        description: 'Dockerfile target stage to build'
        required: false
        type: string
        default: ''

      cache-type:
        description: 'Cache type (gha or registry)'
        required: false
        type: string
        default: 'registry'

      aws-region:
        description: 'AWS region for ECR (required if registry is ecr)'
        required: false
        type: string
        default: 'us-east-1'

      ref:
        description: 'Git ref to checkout (branch, tag, or SHA). Defaults to the ref that triggered the workflow'
        required: false
        type: string
        default: ''

    secrets:
      registry-user:
        description: 'Registry username or AWS Access Key ID'
        required: false

      registry-token:
        description: 'Registry password/token or AWS Secret Access Key'
        required: false

      build-secrets:
        description: 'Build secrets values (multiline string, format: id=value)'
        required: false

    outputs:
      image-tag:
        description: 'The primary image tag that was built'
        value: ${{ jobs.merge.outputs.image-tag }}

      digest:
        description: 'The image digest'
        value: ${{ jobs.merge.outputs.digest }}

      tag:
        description: 'The primary tag (sha-<short_sha> or combined tag if build args provided)'
        value: ${{ jobs.merge.outputs.tag }}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Create build matrix
        id: set-matrix
        run: |
          platforms="${{ inputs.platforms }}"
          IFS=',' read -ra PLATFORMS <<< "$platforms"

          matrix_json="["
          for platform in "${PLATFORMS[@]}"; do
            platform=$(echo "$platform" | xargs)  # trim whitespace

            case "$platform" in
              amd64)
                runner="ubuntu-latest"
                ;;
              arm64)
                runner="linux-arm64"
                ;;
              *)
                echo "Unsupported platform: $platform"
                exit 1
                ;;
            esac

            matrix_json+="{\"arch\":\"$platform\",\"runner\":\"$runner\"},"
          done

          # Remove trailing comma and close array
          matrix_json="${matrix_json%,}]"

          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "Generated matrix: $matrix_json"

  build:
    needs: prepare
    strategy:
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}

    runs-on: ${{ matrix.runner }}

    outputs:
      build-hash: ${{ steps.build-hash.outputs.hash }}
      combined-tag: ${{ steps.build-hash.outputs.combined }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        if: inputs.registry == 'ecr'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.registry-user }}
          aws-secret-access-key: ${{ secrets.registry-token }}
          aws-region: ${{ inputs.aws-region }}

      - name: Login to Amazon ECR
        if: inputs.registry == 'ecr'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Login to Docker Hub
        if: inputs.registry == 'dockerhub' && inputs.push
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.registry-user }}
          password: ${{ secrets.registry-token }}

      - name: Login to GitHub Container Registry
        if: inputs.registry == 'ghcr' && inputs.push
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.registry-user || github.actor }}
          password: ${{ secrets.registry-token || secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.image-name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            ${{ inputs.tags }}

      - name: Generate build hash
        id: build-hash
        run: |
          # Create a deterministic hash from build args and secrets
          BUILD_ARGS="${{ inputs.build-args }}"
          BUILD_SECRETS="${{ secrets.build-secrets }}"

          # Skip if no build args or secrets
          if [[ -z "$BUILD_ARGS" && -z "$BUILD_SECRETS" ]]; then
            echo "No build args or secrets provided, skipping hash generation"
            exit 0
          fi

          # Sort and normalize the build args to ensure consistency
          SORTED_ARGS=""
          if [[ -n "$BUILD_ARGS" ]]; then
            SORTED_ARGS=$(echo "$BUILD_ARGS" | tr '\n' ' ' | tr -s ' ' | xargs -n1 | sort | tr '\n' ' ')
          fi

          # Sort and normalize the secrets (values included in hash for differentiation)
          SORTED_SECRETS=""
          if [[ -n "$BUILD_SECRETS" ]]; then
            SORTED_SECRETS=$(echo "$BUILD_SECRETS" | tr '\n' ' ' | tr -s ' ' | xargs -n1 | sort | tr '\n' ' ')
          fi

          # Combine args and secrets for hashing
          COMBINED_INPUT="${SORTED_ARGS}${SORTED_SECRETS}"

          # Generate short hash (8 chars)
          HASH=$(echo -n "$COMBINED_INPUT" | sha256sum | cut -c1-8)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Generated build hash: $HASH"
          echo "From args: $SORTED_ARGS"

          # Get short commit SHA (7 chars)
          GIT_SHA="${{ github.sha }}"
          SHORT_SHA="${GIT_SHA:0:7}"

          # Determine tag based on event type
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PR: pr-{number} (no build hash)
            PR_NUMBER="${{ github.event.pull_request.number }}"
            COMBINED_TAG="pr-${PR_NUMBER}"
          elif [[ "${{ github.ref_name }}" == "${{ github.event.repository.default_branch }}" ]]; then
            # Default branch: {sha}.b-{hash}
            COMBINED_TAG="${SHORT_SHA}.b-${HASH}"
          else
            # Other branches: {branch} (no build hash)
            BRANCH_NAME="${{ github.ref_name }}"
            # Sanitize branch name for Docker tag (replace / with -)
            SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
            COMBINED_TAG="${SAFE_BRANCH}"
          fi

          echo "combined=$COMBINED_TAG" >> $GITHUB_OUTPUT
          echo "Combined tag: $COMBINED_TAG"

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          target: ${{ inputs.target }}
          platforms: linux/${{ matrix.arch }}
          build-args: ${{ inputs.build-args }}
          secrets: ${{ secrets.build-secrets }}
          outputs: type=image,name=${{ inputs.image-name }},push-by-digest=true,name-canonical=true,push=${{ inputs.push }}
          # Registry cache - persistent and shared across runners
          cache-from: |
            type=registry,ref=${{ inputs.image-name }}:buildcache-${{ matrix.arch }}-${{ github.ref_name }}
            type=registry,ref=${{ inputs.image-name }}:buildcache-${{ matrix.arch }}
          cache-to: type=registry,ref=${{ inputs.image-name }}:buildcache-${{ matrix.arch }}-${{ github.ref_name }},mode=max
          labels: ${{ steps.meta.outputs.labels }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.arch }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  merge:
    runs-on: ubuntu-latest
    needs: [build]
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      digest: ${{ steps.inspect.outputs.digest }}
      tag: ${{ steps.summary.outputs.tag }}

    steps:
      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        if: inputs.registry == 'ecr'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.registry-user }}
          aws-secret-access-key: ${{ secrets.registry-token }}
          aws-region: ${{ inputs.aws-region }}

      - name: Login to Amazon ECR
        if: inputs.registry == 'ecr'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Login to Docker Hub
        if: inputs.registry == 'dockerhub' && inputs.push
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.registry-user }}
          password: ${{ secrets.registry-token }}

      - name: Login to GitHub Container Registry
        if: inputs.registry == 'ghcr' && inputs.push
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.registry-user || github.actor }}
          password: ${{ secrets.registry-token || secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.image-name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            ${{ inputs.tags }}

      - name: Generate build hash
        id: build-hash
        run: |
          # Create a deterministic hash from build args and secrets
          BUILD_ARGS="${{ inputs.build-args }}"
          BUILD_SECRETS="${{ secrets.build-secrets }}"

          # Skip if no build args or secrets
          if [[ -z "$BUILD_ARGS" && -z "$BUILD_SECRETS" ]]; then
            echo "No build args or secrets provided, skipping hash generation"
            exit 0
          fi

          # Sort and normalize the build args to ensure consistency
          SORTED_ARGS=""
          if [[ -n "$BUILD_ARGS" ]]; then
            SORTED_ARGS=$(echo "$BUILD_ARGS" | tr '\n' ' ' | tr -s ' ' | xargs -n1 | sort | tr '\n' ' ')
          fi

          # Sort and normalize the secrets (values included in hash for differentiation)
          SORTED_SECRETS=""
          if [[ -n "$BUILD_SECRETS" ]]; then
            SORTED_SECRETS=$(echo "$BUILD_SECRETS" | tr '\n' ' ' | tr -s ' ' | xargs -n1 | sort | tr '\n' ' ')
          fi

          # Combine args and secrets for hashing
          COMBINED_INPUT="${SORTED_ARGS}${SORTED_SECRETS}"

          # Generate short hash (8 chars)
          HASH=$(echo -n "$COMBINED_INPUT" | sha256sum | cut -c1-8)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "Generated build hash: $HASH"

      - name: Create manifest list and push
        if: inputs.push
        working-directory: /tmp/digests
        run: |
          # Build tag list from metadata
          TAG_ARGS=$(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON")

          # Add combined SHA + build hash tag if build args were provided
          if [[ -n "${{ needs.build.outputs.combined-tag }}" ]]; then
            TAG_ARGS="$TAG_ARGS -t ${{ inputs.image-name }}:${{ needs.build.outputs.combined-tag }}"
            echo "Adding combined tag: ${{ needs.build.outputs.combined-tag }}"
          fi

          docker buildx imagetools create $TAG_ARGS \
            $(printf '${{ inputs.image-name }}@sha256:%s ' *)

      - name: Inspect image
        if: inputs.push
        id: inspect
        run: |
          digest=$(docker buildx imagetools inspect ${{ inputs.image-name }}:${{ steps.meta.outputs.version }} --format '{{json .Manifest.Digest}}' | tr -d '"')
          echo "digest=$digest" >> $GITHUB_OUTPUT
          docker buildx imagetools inspect ${{ inputs.image-name }}:${{ steps.meta.outputs.version }}

      - name: Write job summary
        id: summary
        if: inputs.push
        run: |
          # Build tags list
          TAGS_LIST=$(echo "$DOCKER_METADATA_OUTPUT_JSON" | jq -r '.tags[]' | sed 's/^/- `/' | sed 's/$/`/')
          # Add combined tag if present
          if [[ -n "${{ needs.build.outputs.combined-tag }}" ]]; then
            TAGS_LIST="${TAGS_LIST}
          - \`${{ inputs.image-name }}:${{ needs.build.outputs.combined-tag }}\`"
          fi

          # Output tag: combined-tag if present, otherwise sha-<short_sha>
          if [[ -n "${{ needs.build.outputs.combined-tag }}" ]]; then
            echo "tag=${{ needs.build.outputs.combined-tag }}" >> $GITHUB_OUTPUT
          else
            SHORT_SHA="${{ github.sha }}"
            echo "tag=sha-${SHORT_SHA:0:7}" >> $GITHUB_OUTPUT
          fi

          {
            cat <<EOF
          ## Docker Build Summary

          ### Image
          \`${{ inputs.image-name }}\`

          ### Tags

          ${TAGS_LIST}

          ### Digest
          \`${{ steps.inspect.outputs.digest }}\`

          ### Platforms
          \`${{ inputs.platforms }}\`
          EOF
          } >> $GITHUB_STEP_SUMMARY
