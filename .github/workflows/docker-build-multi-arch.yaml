# .github/workflows/docker-build-multiarch.yml
name: Reusable Multi-Arch Docker Build

on:
  workflow_call:
    inputs:
      image-name:
        description: 'Docker image name (e.g., username/image or ghcr.io/org/image)'
        required: true
        type: string

      context:
        description: 'Build context path'
        required: false
        type: string
        default: '.'

      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'

      platforms:
        description: 'Comma-separated list of platforms (amd64,arm64)'
        required: false
        type: string
        default: 'amd64,arm64'

      registry:
        description: 'Container registry (dockerhub, ghcr, or ecr)'
        required: false
        type: string
        default: 'dockerhub'

      push:
        description: 'Push images to registry'
        required: false
        type: boolean
        default: true

      build-args:
        description: 'Build arguments (multiline string)'
        required: false
        type: string
        default: ''

      tags:
        description: 'Additional custom tags (newline separated)'
        required: false
        type: string
        default: ''

      cache-type:
        description: 'Cache type (gha or registry)'
        required: false
        type: string
        default: 'registry'

      aws-region:
        description: 'AWS region for ECR (required if registry is ecr)'
        required: false
        type: string
        default: 'us-east-1'

    secrets:
      registry-user:
        description: 'Registry username or AWS Access Key ID'
        required: false

      registry-token:
        description: 'Registry password/token or AWS Secret Access Key'
        required: false

    outputs:
      image-tag:
        description: 'The primary image tag that was built'
        value: ${{ jobs.merge.outputs.image-tag }}

      digest:
        description: 'The image digest'
        value: ${{ jobs.merge.outputs.digest }}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Create build matrix
        id: set-matrix
        run: |
          platforms="${{ inputs.platforms }}"
          IFS=',' read -ra PLATFORMS <<< "$platforms"

          matrix_json="["
          for platform in "${PLATFORMS[@]}"; do
            platform=$(echo "$platform" | xargs)  # trim whitespace

            case "$platform" in
              amd64)
                runner="ubuntu-latest"
                ;;
              arm64)
                runner="linux-arm64"
                ;;
              *)
                echo "Unsupported platform: $platform"
                exit 1
                ;;
            esac

            matrix_json+="{\"arch\":\"$platform\",\"runner\":\"$runner\"},"
          done

          # Remove trailing comma and close array
          matrix_json="${matrix_json%,}]"

          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "Generated matrix: $matrix_json"

  build:
    needs: prepare
    strategy:
      matrix:
        include: ${{ fromJson(needs.prepare.outputs.matrix) }}

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        if: inputs.registry == 'ecr'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.registry-user }}
          aws-secret-access-key: ${{ secrets.registry-token }}
          aws-region: ${{ inputs.aws-region }}

      - name: Login to Amazon ECR
        if: inputs.registry == 'ecr'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Login to Docker Hub
        if: inputs.registry == 'dockerhub' && inputs.push
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.registry-user }}
          password: ${{ secrets.registry-token }}

      - name: Login to GitHub Container Registry
        if: inputs.registry == 'ghcr' && inputs.push
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.registry-user || github.actor }}
          password: ${{ secrets.registry-token || secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.image-name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            ${{ inputs.tags }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          platforms: linux/${{ matrix.arch }}
          build-args: ${{ inputs.build-args }}
          outputs: type=image,name=${{ inputs.image-name }},push-by-digest=true,name-canonical=true,push=${{ inputs.push }}
          # Registry cache - persistent and shared across runners
          cache-from: |
            type=registry,ref=${{ inputs.image-name }}:buildcache-${{ matrix.arch }}-${{ github.ref_name }}
            type=registry,ref=${{ inputs.image-name }}:buildcache-${{ matrix.arch }}
          cache-to: type=registry,ref=${{ inputs.image-name }}:buildcache-${{ matrix.arch }}-${{ github.ref_name }},mode=max
          labels: ${{ steps.meta.outputs.labels }}

      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.arch }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  merge:
    runs-on: ubuntu-latest
    needs: [build]
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      digest: ${{ steps.inspect.outputs.digest }}

    steps:
      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        if: inputs.registry == 'ecr'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.registry-user }}
          aws-secret-access-key: ${{ secrets.registry-token }}
          aws-region: ${{ inputs.aws-region }}

      - name: Login to Amazon ECR
        if: inputs.registry == 'ecr'
        uses: aws-actions/amazon-ecr-login@v2

      - name: Login to Docker Hub
        if: inputs.registry == 'dockerhub' && inputs.push
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.registry-user }}
          password: ${{ secrets.registry-token }}

      - name: Login to GitHub Container Registry
        if: inputs.registry == 'ghcr' && inputs.push
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ secrets.registry-user || github.actor }}
          password: ${{ secrets.registry-token || secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.image-name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
            ${{ inputs.tags }}

      - name: Create manifest list and push
        if: inputs.push
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ inputs.image-name }}@sha256:%s ' *)

      - name: Inspect image
        if: inputs.push
        id: inspect
        run: |
          digest=$(docker buildx imagetools inspect ${{ inputs.image-name }}:${{ steps.meta.outputs.version }} --format '{{json .Manifest.Digest}}' | tr -d '"')
          echo "digest=$digest" >> $GITHUB_OUTPUT
          docker buildx imagetools inspect ${{ inputs.image-name }}:${{ steps.meta.outputs.version }}
